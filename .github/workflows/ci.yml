name: CI

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-only:
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/heads/') &&
      github.ref != 'refs/heads/main' &&
      github.ref != 'refs/heads/cs-207'
    env:
      NEXT_PUBLIC_API_URL: http://localhost:4000
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Notify Telegram (failure)
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN}" ] || [ -z "${TELEGRAM_CHAT_ID}" ]; then
            echo "Telegram secrets not set; skipping notification."
            exit 0
          fi
          SHORT_SHA=${GITHUB_SHA::7}
          MESSAGE="‚ùå ${GITHUB_WORKFLOW} lint failed for ${GITHUB_REPOSITORY}@${GITHUB_REF_NAME} (commit ${SHORT_SHA}) by ${GITHUB_ACTOR}"
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"

      - name: Notify Telegram (success)
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN}" ] || [ -z "${TELEGRAM_CHAT_ID}" ]; then
            echo "Telegram secrets not set; skipping notification."
            exit 0
          fi
          SHORT_SHA=${GITHUB_SHA::7}
          MESSAGE="‚úÖ ${GITHUB_WORKFLOW} lint-only run passed for ${GITHUB_REPOSITORY}@${GITHUB_REF_NAME} (commit ${SHORT_SHA}) by ${GITHUB_ACTOR}\n\nüß™ Tests executed: Lint only"
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"

  main-ci:
    runs-on: ubuntu-latest
    needs: []
    if: github.ref == 'refs/heads/main'
    env:
      SUPABASE_TEST_URL: ${{ secrets.SUPABASE_TEST_URL }}
      SUPABASE_TEST_SERVICE_KEY: ${{ secrets.SUPABASE_TEST_SERVICE_KEY }}
      SUPABASE_TEST_ANON_KEY: ${{ secrets.SUPABASE_TEST_ANON_KEY }}
      NEXT_PUBLIC_SUPABASE_URL_SECRET: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY_SECRET: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}
      NEXT_PUBLIC_API_URL: http://localhost:4000
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Configure Supabase environment
        shell: bash
        run: |
          set -euo pipefail
          URL="${NEXT_PUBLIC_SUPABASE_URL_SECRET:-$SUPABASE_TEST_URL}"
          if [ -z "$URL" ]; then
            echo "Supabase URL is not configured" >&2
            exit 1
          fi
          PUBLISHABLE="${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY_SECRET:-$SUPABASE_TEST_ANON_KEY}"
          if [ -z "$PUBLISHABLE" ]; then
            echo "Supabase publishable key missing; using service key fallback" >&2
            PUBLISHABLE="$SUPABASE_TEST_SERVICE_KEY"
          fi
          echo "NEXT_PUBLIC_SUPABASE_URL=$URL" >> "$GITHUB_ENV"
          echo "NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=$PUBLISHABLE" >> "$GITHUB_ENV"
          echo "NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL" >> "$GITHUB_ENV"
          echo "SUPABASE_URL=$SUPABASE_TEST_URL" >> "$GITHUB_ENV"
          echo "SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_TEST_SERVICE_KEY" >> "$GITHUB_ENV"
          if [ -n "$SUPABASE_TEST_ANON_KEY" ]; then
            echo "SUPABASE_ANON_KEY=$SUPABASE_TEST_ANON_KEY" >> "$GITHUB_ENV"
          fi

      - name: Lint
        run: npm run lint

      - name: Unit tests
        run: npm run -s test:unit:ci

      - name: Integration tests
        run: npm run test:integration

      - name: Notify Telegram (failure)
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN}" ] || [ -z "${TELEGRAM_CHAT_ID}" ]; then
            echo "Telegram secrets not set; skipping notification."
            exit 0
          fi
          SHORT_SHA=${GITHUB_SHA::7}
          MESSAGE="‚ùå ${GITHUB_WORKFLOW} failed for ${GITHUB_REPOSITORY}@${GITHUB_REF_NAME} (commit ${SHORT_SHA}) by ${GITHUB_ACTOR}"
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"

      - name: Notify Telegram (success)
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN}" ] || [ -z "${TELEGRAM_CHAT_ID}" ]; then
            echo "Telegram secrets not set; skipping notification."
            exit 0
          fi
          SHORT_SHA=${GITHUB_SHA::7}
          MESSAGE="‚úÖ ${GITHUB_WORKFLOW} passed for ${GITHUB_REPOSITORY}@${GITHUB_REF_NAME} (commit ${SHORT_SHA}) by ${GITHUB_ACTOR}\n\nüß™ Tests executed: Lint, Unit, Integration"
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"

  cs207-ci:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/cs-207'
    env:
      SUPABASE_TEST_URL: ${{ secrets.SUPABASE_TEST_URL }}
      SUPABASE_TEST_SERVICE_KEY: ${{ secrets.SUPABASE_TEST_SERVICE_KEY }}
      SUPABASE_TEST_ANON_KEY: ${{ secrets.SUPABASE_TEST_ANON_KEY }}
      NEXT_PUBLIC_SUPABASE_URL_SECRET: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY_SECRET: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}
      NEXT_PUBLIC_API_URL: http://localhost:4000
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Configure Supabase environment
        shell: bash
        run: |
          set -euo pipefail
          URL="${NEXT_PUBLIC_SUPABASE_URL_SECRET:-$SUPABASE_TEST_URL}"
          if [ -z "$URL" ]; then
            echo "Supabase URL is not configured" >&2
            exit 1
          fi
          PUBLISHABLE="${NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY_SECRET:-$SUPABASE_TEST_ANON_KEY}"
          if [ -z "$PUBLISHABLE" ]; then
            echo "Supabase publishable key missing; using service key fallback" >&2
            PUBLISHABLE="$SUPABASE_TEST_SERVICE_KEY"
          fi
          echo "NEXT_PUBLIC_SUPABASE_URL=$URL" >> "$GITHUB_ENV"
          echo "NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=$PUBLISHABLE" >> "$GITHUB_ENV"
          echo "NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL" >> "$GITHUB_ENV"
          echo "SUPABASE_URL=$SUPABASE_TEST_URL" >> "$GITHUB_ENV"
          echo "SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_TEST_SERVICE_KEY" >> "$GITHUB_ENV"
          if [ -n "$SUPABASE_TEST_ANON_KEY" ]; then
            echo "SUPABASE_ANON_KEY=$SUPABASE_TEST_ANON_KEY" >> "$GITHUB_ENV"
          fi

      - name: Lint
        run: npm run lint

      - name: Unit tests
        run: npm run -s test:unit:ci

      - name: Integration tests
        run: npm run test:integration

      - name: Build for production
        run: npm run build

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npx playwright test --reporter=github

      - name: Notify Telegram (failure)
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN}" ] || [ -z "${TELEGRAM_CHAT_ID}" ]; then
            echo "Telegram secrets not set; skipping notification."
            exit 0
          fi
          SHORT_SHA=${GITHUB_SHA::7}
          MESSAGE="‚ùå ${GITHUB_WORKFLOW} failed for ${GITHUB_REPOSITORY}@${GITHUB_REF_NAME} (commit ${SHORT_SHA}) by ${GITHUB_ACTOR}"
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"

      - name: Notify Telegram (success)
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN}" ] || [ -z "${TELEGRAM_CHAT_ID}" ]; then
            echo "Telegram secrets not set; skipping notification."
            exit 0
          fi
          SHORT_SHA=${GITHUB_SHA::7}
          MESSAGE="‚úÖ ${GITHUB_WORKFLOW} passed for ${GITHUB_REPOSITORY}@${GITHUB_REF_NAME} (commit ${SHORT_SHA}) by ${GITHUB_ACTOR}\n\nüß™ Tests executed: Lint, Unit, Integration, E2E, Build"
          curl -s -X POST https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage \
            -d chat_id=${TELEGRAM_CHAT_ID} \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"


